"use strict";(self.webpackChunkquanlythuchi=self.webpackChunkquanlythuchi||[]).push([[7114],{1499:(e,n,s)=>{s.d(n,{Ol:()=>i,sM:()=>a,s_:()=>r});var o=s(42104);let t=null;const r=e=>{if(t&&t.disconnect(),!e)throw console.error("\u274c Token kh\xf4ng t\u1ed3n t\u1ea1i, kh\xf4ng th\u1ec3 k\u1ebft n\u1ed1i WebSocket"),new Error("Token kh\xf4ng t\u1ed3n t\u1ea1i");const n={NODE_ENV:"production",PUBLIC_URL:"/FinanceFlow",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0,REACT_APP_GEMINI_API_KEY:"AIzaSyDgxajhquGhXa49GLihn_GlNjeJn0-26lE",REACT_APP_STRIPE_PUBLISHABLE_KEY:"pk_test_51R6SFdJ0EYLbnLTiWkEe5KrRUd6XiU8w5YReJTjVjKDKYRCC6C2Wiq3uQHaZCwwuzErUfmbhJ2X4VRLm4ucj85wg00sySUeMf4"}.REACT_APP_API_URL?{NODE_ENV:"production",PUBLIC_URL:"/FinanceFlow",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0,REACT_APP_GEMINI_API_KEY:"AIzaSyDgxajhquGhXa49GLihn_GlNjeJn0-26lE",REACT_APP_STRIPE_PUBLISHABLE_KEY:"pk_test_51R6SFdJ0EYLbnLTiWkEe5KrRUd6XiU8w5YReJTjVjKDKYRCC6C2Wiq3uQHaZCwwuzErUfmbhJ2X4VRLm4ucj85wg00sySUeMf4"}.REACT_APP_API_URL.replace("/api",""):"https://quanlythuchi-backend.onrender.com";return t=(0,o.io)(n,{auth:{token:"Bearer ".concat(e)},transports:["websocket"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3}),t.on("connect_error",(e=>{console.error("Socket connection error:",e.message,e.stack)})),t.on("disconnect",(()=>{console.log("\ud83d\udce1 Socket disconnected")})),console.log("\ud83d\udce1 Socket initialized with full token:","Bearer ".concat(e)),t},i=()=>t,a=()=>{t&&(t.disconnect(),t=null,console.log("\ud83d\udce1 Socket disconnected"))}},97114:(e,n,s)=>{s.r(n),s.d(n,{default:()=>L});var o=s(89379),t=s(75678),r=s(63336),i=s(96446),a=s(85865),l=s(67784),c=s(17392),d=s(35721),h=s(30681),u=s(98587),m=s(58168),g=s(65043),x=s(58387),A=s(98610),p=s(51347),_=s(34535),f=s(98206),S=s(92532),y=s(72372);function E(e){return(0,y.Ay)("MuiListItemAvatar",e)}(0,S.A)("MuiListItemAvatar",["root","alignItemsFlexStart"]);var C=s(70579);const j=["className"],v=(0,_.Ay)("div",{name:"MuiListItemAvatar",slot:"Root",overridesResolver:(e,n)=>{const{ownerState:s}=e;return[n.root,"flex-start"===s.alignItems&&n.alignItemsFlexStart]}})((e=>{let{ownerState:n}=e;return(0,m.A)({minWidth:56,flexShrink:0},"flex-start"===n.alignItems&&{marginTop:8})})),k=g.forwardRef((function(e,n){const s=(0,f.b)({props:e,name:"MuiListItemAvatar"}),{className:o}=s,t=(0,u.A)(s,j),r=g.useContext(p.A),i=(0,m.A)({},s,{alignItems:r.alignItems}),a=(e=>{const{alignItems:n,classes:s}=e,o={root:["root","flex-start"===n&&"alignItemsFlexStart"]};return(0,A.A)(o,E,s)})(i);return(0,C.jsx)(v,(0,m.A)({className:(0,x.A)(a.root,o),ownerState:i,ref:n},t))}));var R=s(28739),w=s(81045),P=s(48734),T=s(1499),I=s(84033);const b=e=>{let{session:n}=e;const[s,o]=(0,g.useState)(""),d=(0,T.Ol)(),h=(0,g.useCallback)((()=>{if(!s.trim()||!d||!d.connected)return void console.error("\u274c Kh\xf4ng th\u1ec3 g\u1eedi tin nh\u1eafn: Socket ch\u01b0a k\u1ebft n\u1ed1i ho\u1eb7c tin nh\u1eafn r\u1ed7ng");const e={_id:Date.now().toString(),sessionId:n._id,sender:"admin",content:s,createdAt:new Date};d.emit("message",e),o("")}),[s,n._id,d]);return(0,C.jsxs)(r.A,{sx:{flexGrow:1,display:"flex",flexDirection:"column",height:"100%"},children:[(0,C.jsx)(i.A,{sx:{p:2,bgcolor:"primary.main",color:"white",borderTopLeftRadius:4,borderTopRightRadius:4},children:(0,C.jsxs)(a.A,{variant:"h6",children:[n.userName," (",n.userEmail,")"]})}),(0,C.jsx)(i.A,{sx:{flexGrow:1,overflowY:"auto",p:2},children:n.messages.map((e=>(0,C.jsx)(i.A,{sx:{mb:1,display:"flex",justifyContent:"admin"===e.sender?"flex-end":"flex-start"},children:(0,C.jsx)(a.A,{sx:{bgcolor:"admin"===e.sender?"primary.main":"grey.200",color:"admin"===e.sender?"white":"text.primary",p:1,borderRadius:2,maxWidth:"70%",fontFamily:"Poppins, sans-serif"},children:e.content})},e._id)))}),(0,C.jsxs)(i.A,{sx:{p:2,display:"flex",alignItems:"center",borderTop:"1px solid",borderColor:"grey.300"},children:[(0,C.jsx)(l.A,{value:s,onChange:e=>o(e.target.value),onKeyPress:e=>"Enter"===e.key&&h(),fullWidth:!0,placeholder:"Nh\u1eadp tin nh\u1eafn...",variant:"outlined",size:"small"}),(0,C.jsx)(c.A,{onClick:h,sx:{ml:1,color:"primary.main"},children:(0,C.jsx)(t.A,{})})]})]})},L=()=>{const[e,n]=(0,g.useState)([]),[s,t]=(0,g.useState)(null),[l,c]=(0,g.useState)(null),u=(0,g.useCallback)((async()=>{try{const e=await I.A.get("/api/admin/support/sessions");console.log("\ud83d\udce1 Sessions fetched:",e.data),n(e.data.sessions||[])}catch(l){var e,s;console.error("Error fetching sessions:",l.message),c("Kh\xf4ng th\u1ec3 t\u1ea3i danh s\xe1ch phi\xean h\u1ed7 tr\u1ee3: "+((null===(e=l.response)||void 0===e||null===(s=e.data)||void 0===s?void 0:s.message)||l.message))}}),[]);return(0,g.useEffect)((()=>{const e=localStorage.getItem("token");if(!e)return void c("B\u1ea1n c\u1ea7n \u0111\u0103ng nh\u1eadp \u0111\u1ec3 truy c\u1eadp h\u1ed7 tr\u1ee3.");const t=(0,T.s_)(e);return t.on("connect",(()=>{console.log("\u2705 Admin connected to support system"),u()})),t.on("connect_error",(e=>{console.error("\u274c Socket connection error:",e.message),c("Kh\xf4ng th\u1ec3 k\u1ebft n\u1ed1i \u0111\u1ebfn h\u1ec7 th\u1ed1ng h\u1ed7 tr\u1ee3: "+e.message)})),t.on("new-session",(e=>{console.log("\ud83d\udce1 New session received:",e),n((n=>[...n,(0,o.A)((0,o.A)({},e),{},{messages:e.messages||[],unreadCount:1})]))})),t.on("message",(e=>{console.log("\ud83d\udce9 New message received:",e),n((n=>n.map((n=>n._id===e.sessionId?(0,o.A)((0,o.A)({},n),{},{messages:[...n.messages,e],unreadCount:(null===s||void 0===s?void 0:s._id)===n._id?0:n.unreadCount+1}):n))))})),t.on("disconnect",(()=>{console.log("\u274c Socket disconnected")})),()=>{console.log("\u2705 Closing socket from AdminSupportPage"),(0,T.sM)()}}),[u,s]),(0,C.jsxs)(i.A,{sx:{p:3},children:[(0,C.jsx)(a.A,{variant:"h4",sx:{mb:3,fontWeight:"bold",color:"#1E3A8A"},children:"Qu\u1ea3n l\xfd h\u1ed7 tr\u1ee3"}),l&&(0,C.jsx)(a.A,{sx:{color:"error.main",mb:2,textAlign:"center"},children:l}),(0,C.jsxs)(i.A,{sx:{display:"flex",height:"calc(100vh - 180px)",gap:2},children:[(0,C.jsxs)(r.A,{sx:{width:{xs:"100%",sm:300},height:"100%",overflow:"auto",bgcolor:"background.paper",borderRadius:2},children:[(0,C.jsx)(a.A,{variant:"h6",sx:{p:2,bgcolor:"#1E3A8A",color:"white",fontFamily:"Poppins, sans-serif"},children:"Danh s\xe1ch ng\u01b0\u1eddi d\xf9ng"}),(0,C.jsx)(d.A,{children:e.length>0?e.map((e=>(0,C.jsxs)(h.Ay,{button:!0,selected:(null===s||void 0===s?void 0:s._id)===e._id,onClick:()=>t(e),sx:{"&.Mui-selected":{bgcolor:"primary.light"},"&:hover":{bgcolor:"grey.100"}},children:[(0,C.jsx)(k,{children:(0,C.jsx)(R.A,{badgeContent:e.unreadCount,color:"error",children:(0,C.jsx)(w.A,{children:e.userName[0]})})}),(0,C.jsx)(P.A,{primary:e.userName,secondary:e.userEmail,primaryTypographyProps:{fontFamily:"Poppins, sans-serif"},secondaryTypographyProps:{fontFamily:"Poppins, sans-serif"}})]},e._id))):(0,C.jsx)(a.A,{sx:{p:2,textAlign:"center",color:"text.secondary"},children:"Ch\u01b0a c\xf3 phi\xean h\u1ed7 tr\u1ee3 n\xe0o"})})]}),(0,C.jsx)(r.A,{sx:{flexGrow:1,height:"100%",display:"flex",flexDirection:"column"},children:s?(0,C.jsx)(b,{session:s}):(0,C.jsx)(i.A,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%"},children:(0,C.jsx)(a.A,{color:"text.secondary",sx:{fontFamily:"Poppins, sans-serif"},children:"Ch\u1ecdn m\u1ed9t ng\u01b0\u1eddi d\xf9ng \u0111\u1ec3 b\u1eaft \u0111\u1ea7u tr\xf2 chuy\u1ec7n"})})})]})]})}}}]);
//# sourceMappingURL=7114.6002f05f.chunk.js.map